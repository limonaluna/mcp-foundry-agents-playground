version: '3.8'

services:
  mcp-server:
    build:
      context: ./app
      dockerfile: Dockerfile
    container_name: mssql-mcp-foundry
    ports:
      - "3000:3000"
    environment:
      # Azure SQL Database
      SERVER_NAME: ${SERVER_NAME}
      DATABASE_NAME: ${DATABASE_NAME}
      CONNECTION_TIMEOUT: ${CONNECTION_TIMEOUT:-120}
      TRUST_SERVER_CERTIFICATE: ${TRUST_SERVER_CERTIFICATE:-true}
      
      # HTTP Server
      PORT: 3000
      NODE_ENV: ${NODE_ENV:-production}
      
      # CORS
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:3000,https://ai.azure.com}
      
      # Authentication
      API_KEY: ${API_KEY}
      ENABLE_RATE_LIMITING: ${ENABLE_RATE_LIMITING:-false}
      RATE_LIMIT_MAX: ${RATE_LIMIT_MAX:-100}
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-60000}
      
      # Azure credentials (for DefaultAzureCredential)
      AZURE_CLIENT_ID: ${AZURE_CLIENT_ID}
      AZURE_TENANT_ID: ${AZURE_TENANT_ID}
      AZURE_CLIENT_SECRET: ${AZURE_CLIENT_SECRET}
      
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1); }).on('error', () => process.exit(1));"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - mcp-network

networks:
  mcp-network:
    driver: bridge
